<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mon Cœur à Distance 💕 — v3 (Temps réel)</title>
  <meta name="description" content="Couple à distance : chat temps réel + album photo synchronisé via Firebase." />
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='0.9em' font-size='90'%3E%F0%9F%92%95%3C/text%3E%3C/svg%3E" />
  <style>
    :root{ --primary:#ff6b6b; --bg1:#667eea; --bg2:#764ba2; --panel:rgba(255,255,255,0.96); --text:#222; --muted:#666; }
    *{box-sizing:border-box} html,body{min-height:100%}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; background:linear-gradient(135deg,var(--bg1),var(--bg2)); margin:0; color:var(--text)}
    .container{max-width:1100px;margin:auto;padding:24px}
    .header{color:#fff;text-align:center;margin:8px 0 18px}
    .header h1{margin:0;font-size:clamp(28px,4vw,48px)} .header p{margin:6px 0 0;opacity:.9}
    .card{background:var(--panel);border-radius:18px;box-shadow:0 10px 30px rgba(0,0,0,.2);padding:22px}
    .row{display:flex;flex-wrap:wrap;gap:12px} .btn{background:#fff;border:0;border-radius:999px;padding:12px 18px;cursor:pointer;box-shadow:0 2px 10px rgba(0,0,0,.08)} .btn.primary{background:var(--primary);color:#fff}
    nav{display:none;justify-content:center;flex-wrap:wrap;gap:10px;margin:12px 0 22px}
    nav .tab{background:rgba(255,255,255,.9);border:0;border-radius:999px;padding:10px 16px;cursor:pointer} nav .tab.active{background:var(--primary);color:#fff}
    section.app{display:none} section.app.active{display:block;animation:fade .35s ease}@keyframes fade{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:none}}
    .connect-grid{display:grid;gap:16px}.field{display:flex;gap:10px;flex-wrap:wrap}.input{flex:1;min-width:260px;padding:12px 14px;border:2px solid #e6e6e6;border-radius:12px;font-size:16px}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:14px}
    .frame{background:#fff;border-radius:12px;box-shadow:0 5px 15px rgba(0,0,0,.08);min-height:230px;display:flex;flex-direction:column;align-items:center;justify-content:center;border:2px dashed #ddd;position:relative;padding:12px;text-align:center}
    .frame.has-photo{border:2px solid var(--primary)} .frame img{max-width:100%;max-height:160px;border-radius:10px}
    .frame .actions{position:absolute;top:8px;right:8px;display:flex;gap:6px}.iconbtn{border:0;border-radius:8px;padding:6px 8px;background:#fff;box-shadow:0 1px 6px rgba(0,0,0,.1);cursor:pointer}
    .chatbox{height:380px;overflow:auto;background:#fafafa;border:2px solid #eee;border-radius:14px;padding:14px;margin-bottom:10px}
    .msg{max-width:70%;margin:8px 0;padding:10px 14px;border-radius:18px;word-wrap:break-word}
    .sent{background:var(--primary);color:#fff;margin-left:auto;border-bottom-right-radius:6px}.recv{background:#e9e9e9;color:#222;border-bottom-left-radius:6px}
    .chat-input{display:flex;gap:8px}
  </style>
</head>
<body>
  <div class="container">
    <header class="header">
      <h1>Mon Cœur à Distance 💕</h1>
      <p>Chat en direct + album partagé (Firebase)</p>
    </header>

    <section id="connect" class="card">
      <div class="connect-grid">
        <h2>💕 Espace de couple</h2>
        <p class="hint">Créez/rejoignez un espace avec un <strong>code couple</strong> (ex. marie-pierre). Partagez ce code à deux et vous verrez le <strong>même chat</strong> et le <strong>même album</strong>.</p>
        <div class="field">
          <input id="couple-name" class="input" placeholder="Nom du couple (ex. Marie & Pierre)" />
          <input id="couple-code" class="input" placeholder="Code couple (min. 4 caractères)" />
        </div>
        <div class="row">
          <button id="btn-create" class="btn primary">Créer l'Espace</button>
          <button id="btn-join" class="btn">Rejoindre</button>
          <button id="btn-enter" class="btn">Entrer</button>
        </div>
      </div>
    </section>

    <nav id="nav">
      <button class="tab active" data-tab="chat">Chat Privé</button>
      <button class="tab" data-tab="photos">Album Photo</button>
      <button id="btn-logout" class="tab" style="background:#ff9aa2;color:#fff">Déconnexion</button>
    </nav>

    <section id="chat" class="app card active">
      <h2>💬 Chat Privé (temps réel)</h2>
      <div id="chatbox" class="chatbox" aria-live="polite"></div>
      <div class="chat-input">
        <input id="chat-input" class="input" placeholder="Tape ton message…" />
        <button id="btn-send" class="btn primary">Envoyer</button>
      </div>
    </section>

    <section id="photos" class="app card">
      <h2>📸 Album Photo Partagé</h2>
      <p>Ajoute des photos : l'autre les verra tout de suite. (Stockées sur Firebase Storage)</p>
      <div id="gallery" class="grid" aria-live="polite"></div>
      <div class="row" style="margin-top:10px">
        <button id="btn-addslot" class="btn primary">Ajouter un emplacement</button>
        <input id="file-picker" type="file" accept="image/*" style="display:none" />
      </div>
    </section>
  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-storage-compat.js"></script>

  <script>
    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));
    const uid = () => Math.random().toString(36).slice(2,10);
    const now = () => Date.now();
    function setActiveApp(id){ $$('.app').forEach(s=>s.classList.toggle('active', s.id===id)); $$('.tab').forEach(b=>b.classList.toggle('active', b.dataset.tab===id)); }
    $$('.tab').forEach(btn=>btn.addEventListener('click',()=> setActiveApp(btn.dataset.tab)));

    let currentRoom = null;
    let me = JSON.parse(localStorage.getItem('mcad.me')||'{}'); if(!me.id){ me.id = uid(); localStorage.setItem('mcad.me', JSON.stringify(me)); }
    let fb = {app:null,auth:null,db:null,storage:null, roomRefs:null};

    // >>> REMPLIS ici avec ta config de la console Firebase (Projet -> App Web)
    const FIREBASE_CONFIG = {
      apiKey: "PASTE_YOUR_API_KEY",
      authDomain: "PASTE_YOUR_AUTH_DOMAIN",
      databaseURL: "PASTE_YOUR_DATABASE_URL",
      projectId: "PASTE_YOUR_PROJECT_ID",
      storageBucket: "PASTE_YOUR_STORAGE_BUCKET",
      messagingSenderId: "PASTE_YOUR_SENDER_ID",
      appId: "PASTE_YOUR_APP_ID"
    };

    async function initFirebase(){
      if(!fb.app){
        if(String(FIREBASE_CONFIG.apiKey||'').startsWith('PASTE')){
          alert("⚠️ Remplis FIREBASE_CONFIG (clé du projet) pour activer le temps réel.");
          return false;
        }
        fb.app = firebase.initializeApp(FIREBASE_CONFIG);
        fb.auth = firebase.auth();
        fb.db = firebase.database();
        fb.storage = firebase.storage();
        await fb.auth.signInAnonymously();
      }
      return true;
    }

    function openNav(){ $('#connect').style.display='none'; $('nav').style.display='flex'; setActiveApp('chat'); }
    function ensureRoom(code){
      currentRoom = code.toLowerCase();
      const base = 'rooms/'+currentRoom;
      fb.roomRefs = {
        messages: fb.db.ref(base+'/messages'),
        photos: fb.db.ref(base+'/photos')
      };
    }

    $('#btn-create').addEventListener('click',()=>{
      const name = $('#couple-name').value.trim();
      const code = $('#couple-code').value.trim();
      if(!name||!code||code.length<4) return alert('Remplis le nom + un code (min 4 caractères)');
      localStorage.setItem('mcad.lastRoom', code.toLowerCase());
      alert('Espace créé ! Clique sur Entrer.');
    });

    $('#btn-join').addEventListener('click',()=>{
      const code = $('#couple-code').value.trim();
      if(!code) return alert('Entre ton code');
      localStorage.setItem('mcad.lastRoom', code.toLowerCase());
      alert('Espace trouvé ! Clique sur Entrer.');
    });

    $('#btn-enter').addEventListener('click', async ()=>{
      const code = localStorage.getItem('mcad.lastRoom') || $('#couple-code').value.trim();
      if(!code || code.length<4) return alert('Entre un code valide');
      const ok = await initFirebase(); if(!ok) return;
      ensureRoom(code);
      mountChat(); mountPhotos();
      openNav();
    });

    $('#btn-logout').addEventListener('click',()=>{
      currentRoom=null; $('nav').style.display='none'; $('#connect').style.display='block';
      if(fb.roomRefs){ fb.roomRefs.messages.off(); fb.roomRefs.photos.off(); }
    });

    // CHAT temps réel
    function mountChat(){
      const box = $('#chatbox'); box.innerHTML='';
      fb.roomRefs.messages.limitToLast(200).on('child_added', snap=>{
        const m = snap.val();
        const d=document.createElement('div'); d.className='msg '+(m.uid===me.id?'sent':'recv'); d.textContent=m.text; box.appendChild(d); box.scrollTop=box.scrollHeight;
      });
    }
    async function sendMsg(){
      const inp=$('#chat-input'); const txt=inp.value.trim(); if(!txt||!currentRoom) return; inp.value='';
      await fb.roomRefs.messages.push({ uid: me.id, text: txt, ts: now() });
    }
    $('#btn-send').addEventListener('click', sendMsg);
    $('#chat-input').addEventListener('keydown', e=>{ if(e.key==='Enter') sendMsg(); });

    // ALBUM partagé (Storage + Realtime DB)
    const gallery = $('#gallery');
    const filePicker = $('#file-picker');

    function mountPhotos(){
      gallery.innerHTML='';
      fb.roomRefs.photos.orderByChild('order').on('value', snap=>{
        gallery.innerHTML='';
        const data = snap.val() || {};
        const arr = Object.keys(data).map(id=>({id, ...data[id]})).sort((a,b)=> (a.order||0)-(b.order||0));
        if(arr.length===0){ for(let i=0;i<3;i++) addSlot(); }
        arr.forEach((ph,idx)=>{
          const f=document.createElement('div'); f.className='frame'+(ph.url?' has-photo':'');
          f.innerHTML = ph.url ? `<div class="actions"><button class="iconbtn" data-act="replace" data-id="${ph.id}">Remplacer</button><button class="iconbtn" data-act="del" data-id="${ph.id}">Supprimer</button></div><img alt="Photo partagée" src="${ph.url}"><p>${ph.caption||'Photo du jour ❤️'}</p>` : `<div>📷</div><p>Ajouter une photo</p>`;
          f.addEventListener('click', (e)=>{
            const act = e.target.dataset.act;
            const pid = e.target.dataset.id || ph.id;
            if(act==='del'){ fb.roomRefs.photos.child(pid).remove(); return; }
            pickAndUpload((url,caption)=>{
              fb.roomRefs.photos.child(pid).set({ url, caption, ts: now(), order: idx });
            });
          });
          gallery.appendChild(f);
        });
      });
    }

    function addSlot(){
      const pid = fb.db.ref().push().key;
      fb.roomRefs.photos.child(pid).set({ url: "", caption: "", ts: now(), order: Date.now() });
    }
    $('#btn-addslot').addEventListener('click',()=> addSlot());

    function pickAndUpload(cb){
      filePicker.onchange = async ()=>{
        const f = filePicker.files[0]; if(!f) return; filePicker.value='';
        const pid = fb.db.ref().push().key;
        const path = `rooms/${currentRoom}/${pid}-${f.name}`;
        const ref = fb.storage.ref().child(path);
        await ref.put(f);
        const url = await ref.getDownloadURL();
        const caption = prompt('Légende ?') || 'Photo du jour ❤️';
        cb(url, caption);
      };
      filePicker.click();
    }
  </script>
</body>
</html>
